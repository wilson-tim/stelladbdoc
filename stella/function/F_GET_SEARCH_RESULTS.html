<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="F_GET_SEARCH_RESULTS/report.js" type="text/javascript"></script>
<link href="F_GET_SEARCH_RESULTS/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">F_GET_SEARCH_RESULTS</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#f_get_search_results">f_get_search_results</A></B>( p_in_ticket_no NUMBER , p_in_pnr CHAR , p_in_booking_ref NUMBER , p_in_season CHAR , p_in_airline_num NUMBER , p_in_pax_name CHAR , p_in_departure_date DATE , p_in_ticket_issue_date DATE , p_in_refund_doc NUMBER , p_in_refund_letter_id NUMBER , p_in_iata_num NUMBER ) RETURN p_stella_get_data . return_refcursor </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in s03 format, not s2003</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME="f_get_search_results"></A>
<H3>f_get_search_results</H3><PRE>          <B>f_get_search_results</B>( p_in_ticket_no NUMBER , p_in_pnr CHAR , p_in_booking_ref NUMBER , p_in_season CHAR , p_in_airline_num NUMBER , p_in_pax_name CHAR , p_in_departure_date DATE , p_in_ticket_issue_date DATE , p_in_refund_doc NUMBER , p_in_refund_letter_id NUMBER , p_in_iata_num NUMBER ) RETURN p_stella_get_data . return_refcursor </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in s03 format, not s2003<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>STELLA</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>F_GET_SEARCH_RESULTS</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>2516784</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>FUNCTION</td>
</tr>
<tr>
<td>CREATED</td>
<td>16-JAN-18</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>08-JAN-20</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2020-01-08:11:55:30</td>
</tr>
<tr>
<td>STATUS</td>
<td>VALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
<tr onclick="table_onSelectMasterRow(this, 1, 0)" class="currentrow">
<td class="currentcell">EXECUTE</td>
<td class="currentcell">STELLAINTRANET</td>
<td class="currentcell">NO</td>
<td class="currentcell">STELLA</td>
<td class="currentcell">F_GET_SEARCH_RESULTS</td>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
FUNCTION f_get_search_results(p_in_ticket_no         NUMBER,
                                                p_in_pnr               CHAR,
                                                p_in_booking_ref       NUMBER,
                                                p_in_season            CHAR, -- in s03 format, not s2003
                                                p_in_airline_num       NUMBER,
                                                p_in_pax_name          CHAR,
                                                p_in_departure_date    DATE,
                                                p_in_ticket_issue_date DATE,
                                                p_in_refund_doc        NUMBER,
                                                p_in_refund_letter_id  NUMBER,
                                                p_in_iata_num          NUMBER)
  RETURN p_stella_get_data.return_refcursor IS

  /* return list of all tickets and refund documents for given criteria
  all arguments are optional - where clause is built dynamically */

  no_input_values  EXCEPTION;

  v_result       p_stella_get_data.return_refcursor;
  v_season_year  season.season_year%TYPE := NULL;
  v_season_type  season.season_type%TYPE := NULL;
  v_sqlstatement VARCHAR2(32000);
  --  v_output_file  utl_file.file_type;

BEGIN
     
  IF p_in_season IS NOT NULL THEN
    v_season_year := '20' || substr(p_in_season, 2, 3);
    v_season_type := substr(p_in_season, 1, 1);
  END IF;
  v_sqlstatement := NULL;

  
  -- This is caused by web application . Added to troubleshoot the cause from where it is called.

  IF p_in_ticket_no IS NULL AND 
     p_in_pnr IS NULL AND
     p_in_booking_ref IS NULL AND
     p_in_airline_num IS NULL AND
     p_in_pax_name IS NULL AND
     p_in_departure_date IS NULL AND
     p_in_ticket_issue_date IS NULL AND
     p_in_refund_doc IS NULL AND 
     p_in_refund_letter_id IS NULL AND
     p_in_iata_num IS NULL THEN
     
     RAISE  no_input_values;
     
 END IF;

  
  IF p_in_refund_doc IS NULL THEN
    IF p_in_refund_letter_id IS NULL THEN
      v_sqlstatement := 'SELECT ' || chr(13);
      v_sqlstatement := v_sqlstatement || '''TKT'' rectype, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'p.pnr_no, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 't.ticket_no, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 't.airline_num, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 't.iata_no, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 't.e_ticket_ind ,' || chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'to_char(t.ticket_issue_date, ''dd/mm/yyyy'') ticket_issue_date, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 't.passenger_name, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'p.booking_reference_no, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 'p.branch_code, ' || chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'p.season_type || substr(p.season_year, 3, 2) season, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'to_char(t.departure_date, ''dd/mm/yyyy'') departure_date, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 'airline.airline_name, ' ||
                        chr(13);
      /* next call returns the season_type that users want to see e.g. C for summer HandJ */
      v_sqlstatement := v_sqlstatement ||
                        'p_stella_get_data.convert_season_type(p.season_type, p.season_year, p.branch_code)|| substr(p.season_year, 3, 2) derived_season, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || '0 refund_document_no, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 'NULL refund_doc_type_code, ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 'NULL issue_date, ' || chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'p_stella_reconciliation.calc_stella_ticket_cost(t.ticket_no) total_doc_cost ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement || 'FROM ticket t, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'pnr p, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'airline, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'ticketing_agent ta, ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'doc_type doc ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'WHERE t.pnr_id = p.pnr_id ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'and ta.ticketing_agent_initials = t.ticketing_agent_initials ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'and airline.airline_num = t.airline_num ' ||
                        chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'and t.doc_type_code = doc.doc_type_code ' ||
                        chr(13);
    
      /* now build rest of where clause dynamically according to what user has entered in search screen */
      /* rules about which columns are mandatory are held in GUI */
      IF p_in_ticket_no IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND  (t.ticket_no = ' ||
                          p_in_ticket_no || ' ' || chr(13);
        v_sqlstatement := v_sqlstatement ||
                          'OR t.ticket_no = (SELECT linked_ticket_no ' ||
                          chr(13);
        v_sqlstatement := v_sqlstatement ||
                          'FROM ticket t3 WHERE t3.ticket_no = ' ||
                          p_in_ticket_no || ') ' || chr(13);
        v_sqlstatement := v_sqlstatement ||
                          'OR t.linked_ticket_no = (SELECT ticket_no ' ||
                          chr(13);
        v_sqlstatement := v_sqlstatement ||
                          'FROM ticket t3 WHERE t3.ticket_no = ' ||
                          p_in_ticket_no || ')) ' || chr(13);
        /* ticket numbers recycle so don't show anything older than 3 years */
        v_sqlstatement := v_sqlstatement ||
                          'AND nvl(t.departure_date,SYSDATE) > (SYSDATE - (365*3)) ' ||
                          chr(13);
      END IF;
    
      IF p_in_pnr IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND p.pnr_no = ''' || p_in_pnr ||
                          ''' ' || chr(13);
      END IF;
    
      IF p_in_booking_ref IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND p.booking_reference_no = ' ||
                          p_in_booking_ref || ' ' || chr(13);
      END IF;
    
      IF v_season_type IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND p.season_type = ''' ||
                          v_season_type || ''' ' || chr(13);
      END IF;
    
      IF v_season_year IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND p.season_year = ''' ||
                          v_season_year || ''' ' || chr(13);
      END IF;
    
      IF p_in_airline_num IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND t.airline_num = ' ||
                          p_in_airline_num || ' ' || chr(13);
      END IF;
    
      IF p_in_iata_num IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND t.iata_no = ' ||
                          p_in_iata_num || ' ' || chr(13);
      END IF;
    
      IF p_in_pax_name IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND t.passenger_name like ''' ||
                          p_in_pax_name || '%'' ' || chr(13);
      END IF;
    
      IF p_in_departure_date IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND t.departure_date = ''' ||
                          p_in_departure_date || ''' ' || chr(13);
      END IF;
    
      IF p_in_ticket_issue_date IS NOT NULL THEN
        v_sqlstatement := v_sqlstatement || 'AND t.ticket_issue_date = ''' ||
                          p_in_ticket_issue_date || ''' ' || chr(13);
      END IF;
    
    END IF;
  
  END IF;

  /* refund doc section -- cannot show a lot for same columns 
  e.g. booking ref, because a refund document can cover many pnrs/bookings 
  */
  IF p_in_refund_letter_id IS NULL THEN
    IF v_sqlstatement IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'UNION ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'SELECT ' || chr(13);
    END IF;
    IF v_sqlstatement IS NULL THEN
      v_sqlstatement := 'SELECT ' || chr(13);
    END IF;
    v_sqlstatement := v_sqlstatement || '''REF'' rectype, ' || chr(13);
    v_sqlstatement := v_sqlstatement || ''' '' pnr_no, ' || chr(13); -- pnr
    v_sqlstatement := v_sqlstatement || '0 ticket_no, ' || chr(13); -- ticket no
    v_sqlstatement := v_sqlstatement || '0 airline_num, ' || chr(13); -- airline num
    v_sqlstatement := v_sqlstatement || '0 iata_no, ' || chr(13); -- iata num
    v_sqlstatement := v_sqlstatement || 'NULL e_ticket_ind, ' || chr(13); -- eticket ind
    v_sqlstatement := v_sqlstatement || 'NULL ticket_issue_date, ' ||
                      chr(13); -- ticket issue date
    v_sqlstatement := v_sqlstatement || 'NULL passenger_name,' || chr(13); -- passenger name
    v_sqlstatement := v_sqlstatement || '0 booking_reference_no, ' ||
                      chr(13); -- booking ref number
    v_sqlstatement := v_sqlstatement || 'NULL branch_code, ' || chr(13); -- branch code
    v_sqlstatement := v_sqlstatement || 'NULL season, ' || chr(13); -- season
    v_sqlstatement := v_sqlstatement || 'NULL departure_date, ' || chr(13); -- departure date
    v_sqlstatement := v_sqlstatement || 'NULL airline_name, ' || chr(13); -- airline NAME
    v_sqlstatement := v_sqlstatement || 'NULL derived_season, ' || chr(13); -- converted season
    v_sqlstatement := v_sqlstatement || 'refb.refund_document_no, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'refb.doc_type_code refund_doc_type_code, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'to_char(refb.issue_date,''dd/mm/yy'') issue_date, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'sum(p_stella_reconciliation.calc_stella_refund_doc_total(refb.refund_document_no, NULL))/count(*) total_doc_cost ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'FROM ticket t, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'pnr p, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'airline, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'ticketing_agent ta, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'doc_type doc, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'refund_batch refb, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'refund_ticket reft ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'WHERE t.pnr_id = p.pnr_id ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'and ta.ticketing_agent_initials = t.ticketing_agent_initials ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'and airline.airline_num = t.airline_num ' || chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'and t.doc_type_code = doc.doc_type_code ' || chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'AND reft.refund_document_no = refb.refund_document_no ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'AND reft.ticket_no = t.ticket_no ' ||
                      chr(13);
  
    /* now build rest of where clause dynamically according to what user has entered in search screen */
    /* rules about which columns are mandatory are held in GUI */
    IF p_in_ticket_no IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.ticket_no = ' ||
                        p_in_ticket_no || ' ' || chr(13);
      v_sqlstatement := v_sqlstatement ||
                        'and nvl(t.departure_date,SYSDATE) > (SYSDATE - (365*3)) ' ||
                        chr(13);
    END IF;
  
    IF p_in_pnr IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.pnr_no = ''' || p_in_pnr ||
                        ''' ' || chr(13);
    END IF;
  
    IF p_in_booking_ref IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.booking_reference_no = ' ||
                        p_in_booking_ref || ' ' || chr(13);
    END IF;
  
    IF v_season_type IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.season_type = ''' ||
                        v_season_type || ''' ' || chr(13);
    END IF;
  
    IF v_season_year IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.season_year = ''' ||
                        v_season_year || ''' ' || chr(13);
    END IF;
  
    IF p_in_airline_num IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.airline_num = ' ||
                        p_in_airline_num || ' ' || chr(13);
    END IF;
  
    IF p_in_iata_num IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.iata_no = ' ||
                        p_in_iata_num || ' ' || chr(13);
    END IF;
  
    IF p_in_pax_name IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.passenger_name like ''' ||
                        p_in_pax_name || '%'' ' || chr(13);
    END IF;
  
    IF p_in_departure_date IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.departure_date = ''' ||
                        p_in_departure_date || ''' ' || chr(13);
    END IF;
  
    IF p_in_ticket_issue_date IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.ticket_issue_date = ''' ||
                        p_in_ticket_issue_date || ''' ' || chr(13);
    END IF;
  
    IF p_in_refund_doc IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and refb.refund_document_no = ' ||
                        p_in_refund_doc || ' ' || chr(13);
    END IF;
  
    v_sqlstatement := v_sqlstatement || 'GROUP BY ''REF'', ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'refb.refund_document_no, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'refb.doc_type_code, ' || chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'to_char(refb.issue_date,''dd/mm/yy'') ' || chr(13);
  END IF;

  IF p_in_refund_doc IS NULL THEN
    IF v_sqlstatement IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'UNION ' || chr(13);
      v_sqlstatement := v_sqlstatement || 'SELECT ' || chr(13);
    END IF;
    IF v_sqlstatement IS NULL THEN
      v_sqlstatement := 'SELECT ' || chr(13);
    END IF;
    v_sqlstatement := v_sqlstatement || '''RFL'' rectype, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'p.pnr_no pnr_no,' || chr(13);
    v_sqlstatement := v_sqlstatement || '0 ticket_no, ' || chr(13); -- ticket no
    v_sqlstatement := v_sqlstatement || 'rl.airline_num airline_num, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || '0 iata_no, ' || chr(13); -- iatanum
    v_sqlstatement := v_sqlstatement || 'NULL e_ticket_ind, ' || chr(13); -- eticket ind
    v_sqlstatement := v_sqlstatement || 'NULL ticket_issue_date, ' ||
                      chr(13); -- ticket issue date
    v_sqlstatement := v_sqlstatement || 'NULL passenger_name, ' || chr(13); -- pax name
    v_sqlstatement := v_sqlstatement ||
                      'p.booking_reference_no booking_reference_no, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'p.branch_code branch_code, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'p.season_type || substr(p.season_year, 3, 2) season, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'to_char(p_stella_get_data.get_first_departure_date(p.pnr_id), ''dd/mm/yyyy'') departure_date, ' ||
                      chr(13); -- departure date   
    v_sqlstatement := v_sqlstatement ||
                      'airline.airline_name airline_name, ' || chr(13); -- airline name
    /* next call returns the season_type that users want to see e.g. C for summer HandJ */
    v_sqlstatement := v_sqlstatement ||
                      'p_stella_get_data.convert_season_type(p.season_type, p.season_year, p.branch_code)|| substr(p.season_year, 3, 2) derived_season, ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'rl.refund_letter_id refund_document_no, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'NULL refund_doc_type_code, ' ||
                      chr(13); -- refund doc type code
    v_sqlstatement := v_sqlstatement ||
                      'to_char(rl.entry_date,''dd/mm/yy'') issue_date, ' ||
                      chr(13); -- refund issue date 
    v_sqlstatement := v_sqlstatement || 'rl.requested_amt total_doc_cost ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'FROM  ticket t, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'pnr p, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'airline, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'refund_letter rl, ' || chr(13);
    v_sqlstatement := v_sqlstatement || 'refund_letter_ticket rt ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'WHERE t.pnr_id = p.pnr_id ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'and airline.airline_num = rl.airline_num ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement ||
                      'AND rl.refund_letter_id = rt.refund_letter_id ' ||
                      chr(13);
    v_sqlstatement := v_sqlstatement || 'AND t.ticket_no = rt.ticket_no ' ||
                      chr(13);
  
    /* now build rest of where clause dynamically according to what user has entered in search screen */
    /* rules about which columns are mandatory are held in GUI */
    IF p_in_ticket_no IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and rt.ticket_no = ' ||
                        p_in_ticket_no || ' ' || chr(13);
      /* ticket numbers recycle so don't show anything older than 3 years */
      v_sqlstatement := v_sqlstatement ||
                        'and nvl(t.departure_date,SYSDATE) > (SYSDATE - (365*3)) ' ||
                        chr(13);
    END IF;
  
    IF p_in_pnr IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.pnr_no = ''' || p_in_pnr ||
                        ''' ' || chr(13);
    END IF;
  
    IF p_in_booking_ref IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.booking_reference_no = ' ||
                        p_in_booking_ref || ' ' || chr(13);
    END IF;
  
    IF v_season_type IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.season_type = ''' ||
                        v_season_type || ''' ' || chr(13);
    END IF;
  
    IF v_season_year IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and p.season_year = ''' ||
                        v_season_year || ''' ' || chr(13);
    END IF;
  
    IF p_in_airline_num IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and rl.airline_num = ' ||
                        p_in_airline_num || ' ' || chr(13);
    END IF;
  
    IF p_in_iata_num IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.iata_no = ' ||
                        p_in_iata_num || ' ' || chr(13);
    END IF;
  
    IF p_in_pax_name IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.passenger_name like ''' ||
                        p_in_pax_name || '%'' ' || chr(13);
    END IF;
  
    IF p_in_departure_date IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.departure_date = ''' ||
                        p_in_departure_date || ''' ' || chr(13);
    END IF;
  
    IF p_in_ticket_issue_date IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and t.ticket_issue_date = ''' ||
                        p_in_ticket_issue_date || ''' ' || chr(13);
    END IF;
  
    IF p_in_refund_letter_id IS NOT NULL THEN
      v_sqlstatement := v_sqlstatement || 'and rl.refund_letter_id = ' ||
                        p_in_refund_letter_id || ' ' || chr(13);
    END IF;
  
  END IF;
  v_sqlstatement := v_sqlstatement ||
                    'order by pnr_no,ticket_no,rectype DESC';

  --v_output_file := utl_file.fopen('/home/dw/SQL_Output','johntest.txt','W',32000);
  --utl_file.put_line(v_output_file,v_sqlstatement);
  --utl_file.fflush(v_output_file);
  --utl_file.fclose(v_output_file);
  p_common.debug_message(v_sqlstatement);

  OPEN v_result FOR v_sqlstatement;
  RETURN(v_result);

  EXCEPTION 
  WHEN no_input_values THEN
    raise_application_error(-20101, 'All Input values are null');

  
            
END; -- end function</pre>
</div>
</div>
</div>
</body>
</html>
