<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="TICKET_RANGE_REPORT/report.js" type="text/javascript"></script>
<link href="TICKET_RANGE_REPORT/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">TICKET_RANGE_REPORT</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#ticket_range_report">ticket_range_report</A></B>( p_iata_no IN NUMBER , p_ticket_no_start IN NUMBER , p_ticket_no_end IN NUMBER , p_sqlerrm OUT CHAR , p_no_of_rows OUT CHAR , p_valid OUT BOOLEAN ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allows flexibilty in design so any level of reconciliation can be started </TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME="ticket_range_report"></A>
<H3>ticket_range_report</H3><PRE>          <B>ticket_range_report</B>( p_iata_no IN NUMBER , p_ticket_no_start IN NUMBER , p_ticket_no_end IN NUMBER , p_sqlerrm OUT CHAR , p_no_of_rows OUT CHAR , p_valid OUT BOOLEAN ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allows flexibilty in design so any level of reconciliation can be started <DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>STELLA</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>TICKET_RANGE_REPORT</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>2516789</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>16-JAN-18</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>08-JAN-20</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2020-01-08:11:55:23</td>
</tr>
<tr>
<td>STATUS</td>
<td>INVALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
procedure ticket_range_report ( p_iata_no IN NUMBER,
                                  p_ticket_no_start IN NUMBER, 
                                  p_ticket_no_end IN NUMBER,
/* some or all of these params will be passed */
/* allows flexibilty in design so any level of reconciliation can be started */
           p_sqlerrm OUT CHAR,
           p_no_of_rows OUT CHAR,
           p_valid OUT BOOLEAN)
IS


  g_version                   VARCHAR2(20) := '001/005';
  g_package_name     CONSTANT VARCHAR2(100) := 'STLDWHSP';
  g_statement NUMBER := 0;
  g_sqlerrm VARCHAR2(500);
  g_sqlcode CHAR(20);
  g_debug BOOLEAN := FALSE;

  g_log_sequence application_log.log_sequence%TYPE;     

  
  v_app_key CHAR(8)  := 'STLTKTR';
  v_parameters          VARCHAR2(200) := substr('Params:'
                                                ||'iata:'||p_iata_no
                                                ||'tkt:'||p_ticket_no_start
                                                ||'tkt:'||p_ticket_no_end
                                                 ,1,200);
v_error_message VARCHAR2(150);
v_run_date DATE;
v_num_ranges NUMBER :=0;

v_msg VARCHAR2(200);

v_lowest NUMBER :=0;
v_highest NUMBER :=0;
v_total_tkts NUMBER :=0;
v_prev_tkt_no NUMBER:=0;
v_num_tkts_this_range NUMBER:= 0;            

CURSOR cursor_ranges IS
   SELECT DISTINCT iata_no
   FROM ticket;
   
CURSOR cursor_ticket_range (vl_iata_no char) IS
SELECT ticket_no, iata_no
FROM ticket t
WHERE t.iata_no = vl_iata_no
ORDER BY iata_no, ticket_no -- this order by ticket_no is crucial
;



BEGIN
      g_statement := 5;
      
--      app_util.setup_logging(v_app_key,'LIVE','ALL');
      
      g_statement := 10;      
      g_log_sequence := 1;

      

      v_msg := v_app_key||' started:'||to_char(SYSDATE,'yy-mon-dd hh24:mi:ss');
      p_common.debug_message(v_msg);      
      app_util.file_log(v_msg);      
      p_common.debug_message('Params:'||v_parameters);
      IF p_ticket_no_end IS NOT NULL THEN
        app_util.file_log('RUNNING USING PARAMETERS, NOT CONTROL TABLE!!!!!!!');
      END IF;


      IF (p_ticket_no_end IS NULL
            AND p_ticket_no_start IS NOT NULL)
      OR (p_ticket_no_end IS NOT NULL
            AND p_ticket_no_start IS NULL) 
      OR  (p_iata_no IS NULL 
            AND p_ticket_no_start IS NOT NULL) 
      OR  (p_iata_no IS NOT NULL 
            AND p_ticket_no_start IS NULL)             
      THEN
            g_statement := 20;      
            p_sqlerrm := 'ERROR, parameters must all be null or not null';
            p_valid:= FALSE;
            app_util.file_log(p_sqlerrm);
            app_util.end_logging;
            RETURN;
      END IF;

      
      v_run_date := SYSDATE;
      v_num_ranges := 0;
      v_msg := 'List of Ticket Ranges Follows';
      p_common.debug_message(v_msg); 
      app_util.file_log(v_msg);           
      v_msg := '-------------------------------';
      p_common.debug_message(v_msg);      
      app_util.file_log(v_msg);            
      
      FOR c_range IN cursor_ranges LOOP
          BEGIN
            g_statement := 40;      
            v_num_ranges := v_num_ranges + 1;
            -- need to store highest/lowest figures so can output the ranges missing
            -- without outputting every single missing ticket



            -- now loop through that entire range looking for each ticket number
            -- log if it does not exist
            g_statement := 50;  
            v_prev_tkt_no := 0;
            v_lowest :=9999999999999;
            v_highest := 0;
            v_num_tkts_this_range := 0;            
            
            
            FOR c_tkt IN cursor_ticket_range(c_range.iata_no) LOOP

                IF v_prev_tkt_no = 0 THEN
                  -- first time through each iata range
                  v_prev_tkt_no := c_tkt.ticket_no -1;
                END IF;
                
                v_total_tkts := v_total_tkts + 1;                
                IF c_tkt.ticket_no &lt; v_lowest THEN
                  v_lowest := c_tkt.ticket_no;
                END IF;
                
                IF c_tkt.ticket_no = v_prev_tkt_no + 1 THEN
                  -- do nothing, we have a consecutive ticket                  
                  v_num_tkts_this_range := v_num_tkts_this_range + 1;
                ELSE
                  -- break on sequence found
                  --output message, reset low/high vars
                   v_msg     := 'Range:iata,'||c_range.iata_no||', from,'||v_lowest||', up to,'||v_prev_tkt_no||',numtkts,'||v_num_tkts_this_range;
                   p_common.debug_message(v_msg);      
                   app_util.file_log(v_msg);                         
                   v_lowest := c_tkt.ticket_no;
                   v_num_tkts_this_range := 1;
                    
                END IF;
                
                v_prev_tkt_no := c_tkt.ticket_no;
                
            END LOOP; -- end c_tkt loop
            
            -- end of the iata range, need to display last complete range
            v_msg     := 'Range:iata,'||c_range.iata_no||', from,'||v_lowest||', up to,'||v_prev_tkt_no||',numtkts,'||v_num_tkts_this_range;
            p_common.debug_message(v_msg);      
            app_util.file_log(v_msg);                         
            
            END;           

            

           
           
      END LOOP;    -- ranges loop

      

       g_statement := 999;
       v_msg := 'End of run';
       app_util.file_log( v_msg);      
       app_util.file_log(null);       
       v_msg := 'iata numbers processed                   :'||v_num_ranges;
       p_common.debug_message(v_msg);
       app_util.file_log( v_msg);      
       v_msg := 'Number of tickets in total :'||v_total_tkts;
       p_common.debug_message(v_msg);
       app_util.file_log( v_msg);      
       v_msg :=      v_app_key||' ended:'||to_char(SYSDATE,'yy-mon-dd hh24:mi:ss');
       p_common.debug_message(v_msg);
       dbms_output.put_line(v_msg);
       app_util.file_log( v_msg);             
         
       p_valid := TRUE;
       p_sqlerrm:= null;
       p_no_of_rows := v_num_ranges;
     
       app_util.end_logging;
   
       COMMIT;
    
    
  EXCEPTION  -- main exception block
    
    WHEN OTHERS THEN
         g_sqlcode := SQLCODE;
         g_sqlerrm := substr(SQLERRM, 1,100);
         ROLLBACK;
         p_common.handle_error(v_app_key||''
                              ,g_statement       -- Code location.
                              ,'900'       -- First Choice error number.
                              ,SQLERRM
                              ,v_parameters
                              );
          app_util.file_log(g_statement,'Gen error'||g_sqlerrm);                                      
          dbms_output.put_line(g_statement||' General error'||g_sqlerrm);
          
          app_util.end_logging;
          p_valid := FALSE;
          p_no_of_rows := 0;
          p_sqlerrm :='Gen Error Stmt:'||g_statement||', '||substr(g_sqlerrm,1,100);
          app_util.log(g_package_name,NULL,g_log_sequence,'ALL','GENERROR','FATAL',
              'Others excp', substr('General error at:'||g_statement||','||g_sqlerrm||' '||v_parameters,1,200));
              


END ticket_range_report;</pre>
</div>
</div>
</div>
</body>
</html>
